# Proteomics database project

This project is to create a database in order to load proteome datasets and ease the query of these datasets.


## Install (python) dependencies in a virtual environment

Python 2.7 and git must be installed.

Postgres needs to be installed too, if you wish to create your own database.

* On Mac install Postgres using http://postgresapp.com/ for OSX which is straight forward and standard Mac app and add /Applications/Postgres.app/Contents/Versions/X.X/bin/ to your path

* On Centos6

```
sudo yum install python-devel postgresql-devel
```

### Clone github project

```
git clone https://github.com/crukci-bioinformatics/proteomics.git
cd proteomics
```

### Install python libraries

```
virtualenv venv
source venv/bin/activate
pip install -r requirements.txt
```

## Create the database (only once)

If the database already exists, all tables will be dropped.

```
python create_db.py
```

## Load data

Convert data into tab separated file using csvkit.

> Note that currently the excel file generated by Proteome Discoverer is unreadable by the conversion tool in2csv. You will need to save it under a new name in excel to get it fixed.

### Load test data (by default loading data v2.1)

```
in2csv data/PR688_v21_test.xlsx | cvsformat -T > data/PR688_v21_test.txt
python load_data.py --proteome-name=TEST-PR688 --proteome-filename=data/PR688_v21_test.txt
```

```
in2csv data/PR526_test.xlsx | csvformat -T > data/PR526_test.txt
python load_data.py --proteome-name=TEST-PR526 --proteome-filename=data/PR526_test.txt --version='v1.4'
```

### Delete test data from the database

```
delete from peptide where protein_id in (select protein.id from protein, project where protein.project_id=project.id and project.proteomics_id='TEST');
delete from protein where project_id in (select id from project where proteomics_id='TEST');
delete from project where proteomics_id='TEST';
```

### Load 5 proteomes

```
in2csv data/PR526.xlsx | csvformat -T > data/PR526.txt
python load_data.py --proteome-name='PR526' --proteome-filename=data/PR526.txt
```

## Query data

### Accessing the proteomics database

- Using the terminal, with pgsql installed:

```
$ psql -h bioinf-prot001.cri.camres.org -p 5432 -U proteomics -d proteomics
psql (9.3.7, server 9.5.4)
WARNING: psql major version 9.3, server major version 9.5.
         Some psql features might not work.
Type "help" for help.

proteomics=> \q
```

-  Using pgadmin http://www.pgadmin.org/

![](docs/pgadmin.png)

- Using DBVisualizer http://www.dbvis.com/

#### Read only access

Instead of using the `proteomics` user who has read/write access onto the proteomics database, a `readonly` account is available for querying.

### Data model

Three tables' database diagram: Project, Protein & Peptide
![](docs/dbdiagram.png)

### Using SQL queries

* get all projects in DB
```
select * from project;
```
* get all proteins within a project
```
select *
from project, protein
where protein.project_id = project.id
and project.proteomics_id = 'PR526';
```
* get all peptides with a certain sequence
```
select *
from project, protein, peptide
where protein.project_id = project.id
and peptide.protein_id = protein.id
and peptide.sequence = 'DLYANTVLSGGTTMYPGIADR';
```
* get all proteins with a certain accession and all associated peptides
```
select *
from project, protein, peptide
where protein.project_id = project.id
and peptide.protein_id = protein.id
and protein.accession = 'P63261'
```

### Using python

```
python query_data.py
```

### Using Galaxy

See [README](galaxy_proteomics/README.md)

## On windows

### Installation steps

Download Python 2.7 from https://www.python.org/downloads/release/python-2713/
Open the windows `Command Prompt` and type these commands:

Testing python is installed:
```
C:\Python27\python.exe
>>> quit()
```

Download zip file in `C:\Files\` folder on github from https://github.com/crukci-bioinformatics/proteomics/archive/master.zip and unzip it

Open the windows `Command Prompt` and type these commands:
```
cd C:\Files\proteomics-master\proteomics-master\

C:\Python27\Scripts\pip.exe install virtualenv
C:\Python27\Scripts\virtualenv.exe venv

venv\Scripts\activate.bat
pip install -r requirements.txt
```

### Loading file steps

It consists of two steps, converting the excel file into tab delimited file and loading it into the database using the `load_data.py` python script.

It is important to make sure the output file from step 1 `PRxxx.txt` is the same as the one used in step 2 `--proteome-filename=PRxxx.txt`
```
cd C:\Files\proteomics-master\proteomics-master\
venv\Scripts\activate.bat

in2csv PRxxx.xlsx | csvformat -T > PRxxx.txt
python load_data.py --proteome-name=PRxxx --proteome-filename=PRxxx.txt
```
